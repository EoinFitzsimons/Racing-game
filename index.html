<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>International Racing Championship</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        #gameContainer {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            padding: 20px;
        }

        #mainContent {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #raceDisplay {
            background: rgba(0,0,0,0.9);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            min-height: 450px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            line-height: 1.6;
        }

        #trackConditions {
            background: rgba(0,50,100,0.3);
            border: 1px solid #0080ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        #raceNarrative {
            background: rgba(0,0,0,0.5);
            border-left: 4px solid #FFD700;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        #raceProgress {
            background: rgba(0,100,0,0.2);
            border: 1px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        #sidePanel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #ui {
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 8px;
        }

        #bettingPanel {
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 8px;
            max-height: 350px;
            overflow-y: auto;
        }

        #leaderboard {
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 8px;
            min-height: 200px;
        }

        #commentary {
            padding: 15px;
            background: rgba(0,0,0,0.9);
            border: 1px solid #555;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .commentary-line {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #FFD700;
            background: rgba(255,255,255,0.05);
            font-size: 13px;
            animation: fadeIn 0.5s ease-in;
            border-radius: 3px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .team-card {
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .team-card.selected {
            background: rgba(255,215,0,0.3);
            box-shadow: 0 0 15px rgba(255,215,0,0.5);
        }

        .team-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .team-story {
            font-size: 11px;
            color: #ccc;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .team-odds {
            font-size: 12px;
            color: #4CAF50;
            font-weight: bold;
        }

        #betControls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        #betAmount {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-align: center;
            font-size: 14px;
        }

        #placeBetBtn, #startRaceBtn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        #placeBetBtn:hover, #startRaceBtn:hover {
            background: #45a049;
        }

        #placeBetBtn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        #wallet {
            background: rgba(255,215,0,0.2);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #FFD700;
            font-size: 14px;
            font-weight: bold;
        }

        .position-item {
            margin: 5px 0;
            font-size: 14px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-number {
            font-weight: bold;
            width: 30px;
            font-size: 16px;
        }

        .position-change {
            font-size: 12px;
            font-weight: bold;
        }

        .position-up { color: #4CAF50; }
        .position-down { color: #f44336; }
        .position-same { color: #FFD700; }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #45a049);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        #raceResults {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 1000;
            border: 2px solid #FFD700;
            max-width: 500px;
        }

        .story-details {
            background: rgba(0,0,0,0.9);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 40px;
            display: none;
            z-index: 1001;
            overflow-y: auto;
        }

        .story-content {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
        }

        .close-story {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        @media (max-width: 1200px) {
            #gameContainer {
                grid-template-columns: 1fr;
                max-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="mainContent">
            <div id="raceDisplay">
                <div id="trackConditions">
                    <h3>üèÅ INTERNATIONAL RACING CHAMPIONSHIP üèÅ</h3>
                    <p id="trackInfo">Circuit: Silverstone International | Length: 5.891 km | 20 Laps</p>
                    <p id="weatherInfo">Weather: Partly Cloudy | Air: 22¬∞C | Track: 28¬∞C | Grip: High</p>
                    <p id="raceInfo">Race Duration: ~5 minutes | Field: 8 Professional Drivers</p>
                </div>
                
                <div id="raceProgress">
                    <h4>‚è±Ô∏è Race Progress</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;">0% Complete</div>
                    </div>
                    <p id="progressText">Race will begin shortly - Place your bets!</p>
                </div>
                
                <div id="raceNarrative">
                    <h4>üì¢ Race Director</h4>
                    <p>Welcome to the International Racing Championship! The world's top drivers are on the grid, engines warming up. The championship battle continues with today's 20-lap sprint race at the legendary Silverstone circuit.</p>
                    <p><strong>Drivers are ready - place your bets before the lights go out!</strong></p>
                </div>
                
                <div id="liveRaceText"></div>
            </div>
        </div>
        
        <div id="sidePanel">
            <div id="ui">
                <div style="display: flex; justify-content: space-between; font-size: 14px;">
                    <div><strong>Race:</strong> <span id="raceNumber">1</span></div>
                    <div><strong>Time:</strong> <span id="timer">0:00</span></div>
                    <div><strong>Status:</strong> <span id="raceStatus">Betting Open</span></div>
                </div>
            </div>

            <div id="bettingPanel">
                <div id="wallet">
                    üí∞ Wallet: $<span id="money">1000</span>
                </div>
                
                <h4 style="text-align: center; margin-bottom: 15px; font-size: 16px;">üèÅ Championship Teams</h4>
                
                <div id="teamsList"></div>
                
                <div id="betControls">
                    <input type="number" id="betAmount" placeholder="Bet Amount" min="10" max="1000" value="50">
                    <button id="placeBetBtn" disabled>Place Bet</button>
                    <button id="startRaceBtn">üö¶ LIGHTS OUT!</button>
                </div>
                
                <div id="currentBet" style="margin-top: 10px; font-size: 12px; color: #FFD700;"></div>
            </div>

            <div id="leaderboard">
                <div style="font-weight: bold; margin-bottom: 15px; font-size: 16px;">üèÜ Live Standings</div>
                <div id="positions"></div>
            </div>

            <div id="commentary">
                <div style="font-weight: bold; margin-bottom: 15px; font-size: 16px;">üìª Race Commentary</div>
                <div id="commentaryFeed"></div>
            </div>
        </div>

        <div id="raceResults">
            <h2>üèÅ Race Complete!</h2>
            <div id="winnerAnnouncement"></div>
            <div id="payoutInfo"></div>
            <button onclick="resetRace()" style="margin-top: 20px; padding: 15px 25px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Next Race</button>
        </div>

        <div id="storyDetails" class="story-details">
            <button class="close-story" onclick="closeStory()">‚úï</button>
            <div class="story-content" id="storyContent"></div>
        </div>
    </div>

    <script>
        // Realistic racing teams with grounded backstories
        const teams = [
            {
                id: 0,
                name: "Velocity Motorsport",
                color: "#ff4444",
                nationality: "British",
                driver: "James Mitchell",
                car: "VM-23 Hybrid",
                team_description: "Former F1 mechanics turned independent team",
                story: "Founded by ex-McLaren chief mechanic David Velocity after leaving Formula 1. The team started in British touring cars and worked their way up through sheer determination and innovative engineering solutions.",
                racing_style: "Aggressive overtaking with precise technical execution",
                signature_move: "Late-braking dive bombs into turn 1",
                background: "Started in garage in Oxfordshire, now competing internationally",
                sponsor: "RedShift Energy Drinks",
                championships: "3x British Touring Car podiums",
                odds: "4:1",
                skill: 0.75,
                personality: "aggressive"
            },
            {
                id: 1,
                name: "Apex Racing Team",
                color: "#44ff44",
                nationality: "German",
                driver: "Klaus Weber",
                car: "ART-24 Turbo",
                team_description: "Precision German engineering meets racing passion",
                story: "Klaus Weber, former Porsche test driver, founded Apex Racing after retiring from the WEC. The team focuses on methodical preparation and data-driven race strategies, typical of German engineering excellence.",
                racing_style: "Technical precision with calculated risk-taking",
                signature_move: "Perfect racing lines through technical sections",
                background: "Based in Stuttgart with Porsche heritage",
                sponsor: "TechFlow Automotive Solutions",
                championships: "2x N√ºrburgring 24h class winner",
                odds: "3:1",
                skill: 0.80,
                personality: "technical"
            },
            {
                id: 2,
                name: "Thunder Bay Racing",
                color: "#4444ff",
                nationality: "Canadian",
                driver: "Sarah Thompson",
                car: "TBR-23 Arctic",
                team_description: "Canadian team specializing in all-weather racing",
                story: "Sarah Thompson started racing on frozen lakes in northern Canada. Thunder Bay Racing brings that harsh-weather experience to international circuits, excelling in difficult conditions where others struggle.",
                racing_style: "Consistent pace with exceptional wet weather skills",
                signature_move: "Maintaining speed in adverse conditions",
                background: "Founded in Thunder Bay, Ontario in 2019",
                sponsor: "Maple Leaf Automotive",
                championships: "Canadian Road Racing champion",
                odds: "5:1",
                skill: 0.70,
                personality: "steady"
            },
            {
                id: 3,
                name: "Phoenix Racing",
                color: "#ffff44",
                nationality: "American",
                driver: "Miguel Rodriguez",
                car: "PHX-24 Desert",
                team_description: "Underdog team from Arizona with big dreams",
                story: "Miguel Rodriguez learned to race on desert dirt tracks near Phoenix. His family-run team operates on a shoestring budget but makes up for it with heart, innovation, and an never-give-up attitude that embodies the American dream.",
                racing_style: "Underdog determination with surprising late-race pace",
                signature_move: "Finding speed when it matters most",
                background: "Family-owned team from Phoenix, Arizona",
                sponsor: "Desert Storm Auto Parts",
                championships: "Multiple regional desert racing titles",
                odds: "6:1",
                skill: 0.65,
                personality: "underdog"
            },
            {
                id: 4,
                name: "Sakura Motorsport",
                color: "#ff44ff",
                nationality: "Japanese",
                driver: "Yuki Tanaka",
                car: "SKR-24 Zen",
                team_description: "Japanese precision meets traditional racing philosophy",
                story: "Yuki Tanaka comes from a family of samurai tradition, applying centuries-old principles of discipline and precision to modern racing. Sakura Motorsport represents the harmony between traditional Japanese values and cutting-edge technology.",
                racing_style: "Smooth, flowing style with perfect car control",
                signature_move: "Seamless, graceful overtakes through rhythm",
                background: "Based in Suzuka with deep racing heritage",
                sponsor: "Rising Sun Technologies",
                championships: "Super GT series podium finisher",
                odds: "7:1",
                skill: 0.60,
                personality: "mystical"
            },
            {
                id: 5,
                name: "Nordic Thunder",
                color: "#44ffff",
                nationality: "Finnish",
                driver: "Mikko Virtanen",
                car: "NT-24 Ice",
                team_description: "Finnish rally expertise adapted for circuit racing",
                story: "Mikko Virtanen, son of a legendary rally driver, brings Nordic rally techniques to circuit racing. His smooth, flowing style was developed on icy Finnish forest roads where precision means survival.",
                racing_style: "Smooth, efficient driving with rally-bred car control",
                signature_move: "Flowing through corners like water over ice",
                background: "Rally heritage from Finnish forests",
                sponsor: "Arctic Performance Solutions",
                championships: "Multiple Finnish rally championships",
                odds: "5:1",
                skill: 0.72,
                personality: "smooth"
            },
            {
                id: 6,
                name: "Outback Racing",
                color: "#ffa544",
                nationality: "Australian",
                driver: "Jake Morrison",
                car: "OR-24 Wildfire",
                team_description: "Australian endurance specialists with no fear",
                story: "Jake Morrison grew up racing V8 Supercars in the Australian outback. Known for taking risks that others won't, he brings that fearless Aussie spirit to every race, often pulling off moves that shouldn't be possible.",
                racing_style: "High-risk, high-reward with exceptional car control",
                signature_move: "Impossible overtakes that somehow work",
                background: "V8 Supercar heritage from Mount Panorama",
                sponsor: "Southern Cross Mining",
                championships: "Bathurst 1000 podium finisher",
                odds: "4:1",
                skill: 0.78,
                personality: "risky"
            },
            {
                id: 7,
                name: "Wildcard Racing",
                color: "#a544ff",
                nationality: "Italian",
                driver: "Antonio Rossi",
                car: "WC-24 Chaos",
                team_description: "Unpredictable Italian passion meets racing artistry",
                story: "Antonio Rossi is known throughout the paddock as completely unpredictable. Some days he's brilliant, other days erratic. His emotional Italian racing style means you never know which Antonio will show up, making him the ultimate wildcard.",
                racing_style: "Emotionally driven with moments of pure brilliance",
                signature_move: "Unpredictable moves that confuse competitors",
                background: "Street racing roots from Milan",
                sponsor: "Espresso Velocity Caf√©",
                championships: "Multiple amateur karting titles",
                odds: "8:1",
                skill: 0.55,
                personality: "erratic"
            }
        ];

        const raceEvents = [
            "nails the braking point perfectly",
            "carries extra speed through the chicane",
            "finds the ideal racing line",
            "makes a clinical overtake on the straight",
            "defends position with smart positioning",
            "gains time in the technical sector",
            "loses grip slightly on corner exit",
            "makes a small mistake but recovers",
            "locks up slightly under braking",
            "runs wide but keeps position",
            "sets a personal best sector time",
            "shows great racecraft under pressure",
            "maximizes straight-line speed",
            "demonstrates excellent tire management",
            "finds pace when needed most",
            "struggles with handling balance",
            "adapts driving style to conditions",
            "executes perfect defensive driving",
            "capitalizes on slipstream opportunity",
            "shows championship-level composure"
        ];

        class RealisticRacingGame {
            constructor() {
                this.gameState = 'betting'; // betting, racing, finished
                this.startTime = 0;
                this.raceNumber = 1;
                this.totalRaceDuration = 5 * 60 * 1000; // 5 minutes in milliseconds
                this.totalLaps = 20;
                this.currentLap = 0;
                this.raceProgress = 0;
                
                this.drivers = [];
                this.commentary = [];
                this.lastCommentaryTime = 0;
                
                this.playerMoney = 1000;
                this.currentBet = null;
                this.selectedTeam = null;
                
                this.setupUI();
                this.setupDrivers();
                this.updateTeamsList();
                this.addCommentary("üèÅ Welcome to the International Racing Championship! Drivers are warming up their engines.");
                this.startRaceUpdates();
            }
            
            setupDrivers() {
                this.drivers = teams.map((team, i) => ({
                    id: team.id,
                    team: team,
                    position: i + 1,
                    previousPosition: i + 1,
                    lap: 0,
                    lapProgress: 0,
                    lapTimes: [],
                    totalTime: 0,
                    finished: false,
                    finishTime: 0,
                    raceSkill: Math.max(0.4, Math.min(0.95, team.skill + (Math.random() - 0.5) * 0.2)),
                    currentPace: 1.0,
                    momentum: 1.0,
                    personality: team.personality,
                    lastEventTime: 0
                }));
            }
            
            setupUI() {
                document.getElementById('startRaceBtn').addEventListener('click', () => {
                    if (this.gameState === 'betting') {
                        this.startRace();
                    }
                });
                
                document.getElementById('placeBetBtn').addEventListener('click', () => {
                    this.placeBet();
                });
                
                document.getElementById('betAmount').addEventListener('input', (e) => {
                    this.updateBetButton();
                });
            }
            
            updateTeamsList() {
                const teamsList = document.getElementById('teamsList');
                teamsList.innerHTML = '';
                
                teams.forEach(team => {
                    const teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    teamCard.style.borderLeftColor = team.color;
                    teamCard.onclick = () => this.selectTeam(team);
                    teamCard.ondblclick = () => this.showStory(team);
                    
                    teamCard.innerHTML = `
                        <div class="team-name" style="color: ${team.color}">${team.name}</div>
                        <div class="team-story">${team.team_description}</div>
                        <div style="font-size: 10px; color: #999; margin: 3px 0;">üèéÔ∏è ${team.driver} (${team.nationality}) | ${team.car}</div>
                        <div class="team-odds">Odds: ${team.odds} | Skill: ${Math.round(team.skill * 100)}%</div>
                    `;
                    
                    teamsList.appendChild(teamCard);
                });
                
                this.updateBetButton();
            }
            
            selectTeam(team) {
                this.selectedTeam = team;
                
                document.querySelectorAll('.team-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.target.closest('.team-card').classList.add('selected');
                
                this.updateBetButton();
            }
            
            updateBetButton() {
                const betBtn = document.getElementById('placeBetBtn');
                const betAmount = parseInt(document.getElementById('betAmount').value) || 0;
                
                if (this.selectedTeam && betAmount >= 10 && betAmount <= this.playerMoney && !this.currentBet) {
                    betBtn.disabled = false;
                    betBtn.textContent = `Bet $${betAmount} on ${this.selectedTeam.name}`;
                } else if (this.currentBet) {
                    betBtn.disabled = true;
                    betBtn.textContent = 'Bet Placed ‚úì';
                } else {
                    betBtn.disabled = true;
                    betBtn.textContent = 'Select Team & Amount';
                }
            }
            
            placeBet() {
                if (!this.selectedTeam) return;
                
                const betAmount = parseInt(document.getElementById('betAmount').value) || 0;
                if (betAmount < 10 || betAmount > this.playerMoney) return;
                
                this.currentBet = {
                    team: this.selectedTeam,
                    amount: betAmount
                };
                
                this.playerMoney -= betAmount;
                document.getElementById('money').textContent = this.playerMoney;
                document.getElementById('currentBet').innerHTML = `
                    üéØ Bet: $${betAmount} on <span style="color: ${this.selectedTeam.color}">${this.selectedTeam.name}</span>
                `;
                
                this.addCommentary(`üí∞ ${this.selectedTeam.name} gets crowd support with a $${betAmount} bet from the stands!`);
                this.updateBetButton();
            }
            
            showStory(team) {
                const storyContent = document.getElementById('storyContent');
                storyContent.innerHTML = `
                    <h2 style="color: ${team.color}; text-align: center; margin-bottom: 20px;">${team.name}</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div><strong>Driver:</strong> ${team.driver}</div>
                        <div><strong>Nationality:</strong> ${team.nationality}</div>
                        <div><strong>Car:</strong> ${team.car}</div>
                        <div><strong>Sponsor:</strong> ${team.sponsor}</div>
                        <div><strong>Background:</strong> ${team.background}</div>
                        <div><strong>Championships:</strong> ${team.championships}</div>
                    </div>
                    
                    <h3>Team Story</h3>
                    <p style="margin-bottom: 15px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid ${team.color};">
                        ${team.story}
                    </p>
                    
                    <h3>Racing Style</h3>
                    <p style="margin-bottom: 10px;">${team.racing_style}</p>
                    
                    <h3>Signature Move</h3>
                    <p style="font-style: italic; color: ${team.color};">${team.signature_move}</p>
                `;
                
                document.getElementById('storyDetails').style.display = 'block';
            }
            
            startRace() {
                this.gameState = 'racing';
                this.startTime = Date.now();
                this.currentLap = 1;
                this.raceProgress = 0;
                document.getElementById('raceStatus').textContent = 'Racing!';
                
                this.setupDrivers();
                this.updateRaceNarrative("üö¶ LIGHTS OUT AND AWAY WE GO! The field charges into turn 1 as the 20-lap sprint race begins!");
                this.addCommentary("üèÅ GREEN FLAG! All drivers are racing hard into the first corner!");
                
                // Fast-paced race simulation for 5-minute duration
                this.raceSimulationInterval = setInterval(() => this.simulateRaceProgress(), 800); // Every 0.8 seconds
                
                // End race after exactly 5 minutes
                this.raceTimeoutInterval = setTimeout(() => {
                    if (this.gameState === 'racing') {
                        this.forceRaceEnd();
                    }
                }, this.totalRaceDuration);
            }
            
            simulateRaceProgress() {
                if (this.gameState !== 'racing') return;
                
                const elapsed = Date.now() - this.startTime;
                this.raceProgress = Math.min(100, (elapsed / this.totalRaceDuration) * 100);
                
                // Update progress bar
                const progressFill = document.getElementById('progressFill');
                progressFill.style.width = `${this.raceProgress}%`;
                progressFill.textContent = `${Math.round(this.raceProgress)}% Complete`;
                
                // Calculate current lap based on progress
                const newLap = Math.floor((this.raceProgress / 100) * this.totalLaps) + 1;
                if (newLap > this.currentLap && newLap <= this.totalLaps) {
                    this.currentLap = newLap;
                    this.addCommentary(`üèÅ Lap ${this.currentLap} of ${this.totalLaps} - The field is heating up!`);
                    
                    if (this.currentLap === 10) {
                        this.updateRaceNarrative("üîÑ HALFWAY POINT! We're at the midpoint of this thrilling 20-lap sprint race. Positions are constantly changing as drivers push their cars to the limit!");
                    } else if (this.currentLap === 18) {
                        this.updateRaceNarrative("üî• FINAL LAPS! Just 3 laps to go! The championship battle is reaching its crescendo as drivers give everything they have!");
                    }
                }
                
                // Simulate each driver's progress
                this.drivers.forEach(driver => {
                    if (driver.finished) return;
                    
                    // Apply personality-based pace
                    let paceModifier = this.calculatePaceModifier(driver);
                    
                    // Update driver progress
                    driver.lapProgress += 0.8 * driver.raceSkill * paceModifier * (0.8 + Math.random() * 0.4);
                    
                    // Random race events
                    if (Math.random() < 0.12 && Date.now() - driver.lastEventTime > 5000) {
                        this.generateRaceEvent(driver);
                        driver.lastEventTime = Date.now();
                    }
                    
                    // Check for lap completion based on race progress
                    if (this.raceProgress > 95 && !driver.finished) {
                        driver.finished = true;
                        driver.finishTime = Date.now() - this.startTime;
                        driver.lap = this.totalLaps;
                        this.addCommentary(`üèÜ ${driver.team.name} crosses the finish line!`);
                        
                        if (this.drivers.filter(d => d.finished).length === 1) {
                            this.updateRaceNarrative(`ü•á CHECKERED FLAG! ${driver.team.name} takes victory in a spectacular finish! What an incredible race!`);
                        }
                    }
                });
                
                this.updatePositions();
                this.generateRaceCommentary();
                
                // Check if race should end
                if (this.raceProgress >= 100) {
                    this.forceRaceEnd();
                }
            }
            
            calculatePaceModifier(driver) {
                let modifier = 1.0;
                const racePhase = this.raceProgress / 100;
                
                switch (driver.personality) {
                    case "aggressive":
                        modifier = 1.0 + Math.random() * 0.12;
                        break;
                    case "technical":
                        modifier = 1.06 + (racePhase * 0.05); // Gets better as race progresses
                        break;
                    case "steady":
                        modifier = 1.02;
                        break;
                    case "underdog":
                        modifier = 0.95 + (racePhase * 0.15); // Strong finish
                        break;
                    case "mystical":
                        modifier = 1.0 + Math.sin(Date.now() * 0.001) * 0.08;
                        break;
                    case "smooth":
                        modifier = 1.04 + (Math.random() * 0.04);
                        break;
                    case "risky":
                        modifier = 1.08 + Math.random() * 0.15 - 0.075;
                        break;
                    case "erratic":
                        modifier = 0.85 + Math.random() * 0.3;
                        break;
                }
                
                return modifier;
            }
            
            generateRaceEvent(driver) {
                const event = raceEvents[Math.floor(Math.random() * raceEvents.length)];
                const impact = Math.random() > 0.5 ? 0.08 : -0.08;
                
                driver.momentum += impact;
                driver.momentum = Math.max(0.7, Math.min(1.3, driver.momentum));
                
                this.addCommentary(`üèéÔ∏è ${driver.team.driver} ${event}!`);
            }
            
            updatePositions() {
                // Sort drivers by race progress and skill
                this.drivers.sort((a, b) => {
                    if (a.finished && !b.finished) return -1;
                    if (!a.finished && b.finished) return 1;
                    if (a.finished && b.finished) return a.finishTime - b.finishTime;
                    
                    // Sort by progress and skill combination
                    const aScore = a.lapProgress * a.raceSkill * a.momentum;
                    const bScore = b.lapProgress * b.raceSkill * b.momentum;
                    return bScore - aScore;
                });
                
                // Update positions and track changes
                this.drivers.forEach((driver, index) => {
                    driver.previousPosition = driver.position;
                    driver.position = index + 1;
                });
                
                // Generate position change commentary
                this.drivers.forEach(driver => {
                    if (driver.previousPosition !== driver.position && this.gameState === 'racing') {
                        if (driver.position < driver.previousPosition) {
                            this.addCommentary(`üìà ${driver.team.name} moves up to P${driver.position}!`);
                        } else if (driver.position > driver.previousPosition) {
                            this.addCommentary(`üìâ ${driver.team.name} drops to P${driver.position}`);
                        }
                    }
                });
                
                this.updateLeaderboardDisplay();
                this.updateProgressText();
            }
            
            updateProgressText() {
                const progressText = document.getElementById('progressText');
                const leader = this.drivers[0];
                const timeRemaining = Math.max(0, this.totalRaceDuration - (Date.now() - this.startTime));
                const minutesLeft = Math.floor(timeRemaining / 60000);
                const secondsLeft = Math.floor((timeRemaining % 60000) / 1000);
                
                progressText.textContent = `Leader: ${leader.team.name} | Time Remaining: ${minutesLeft}:${secondsLeft.toString().padStart(2, '0')}`;
            }
            
            generateRaceCommentary() {
                if (Math.random() < 0.3) {
                    const randomDriver = this.drivers[Math.floor(Math.random() * this.drivers.length)];
                    const events = [
                        `üéØ ${randomDriver.team.name} showing excellent pace through the technical section`,
                        `‚ö° ${randomDriver.team.driver} posts the fastest sector time of the race so far`,
                        `üî• ${randomDriver.team.name} is really pushing hard in these final stages`,
                        `üí® ${randomDriver.team.name} gains valuable time on the main straight`,
                        `üé¢ Beautiful driving from ${randomDriver.team.driver} through the chicane`,
                        `‚öñÔ∏è ${randomDriver.team.name} managing their tires perfectly`,
                        `üé™ Masterful racecraft being displayed by ${randomDriver.team.driver}`
                    ];
                    
                    if (!randomDriver.finished && Math.random() < 0.6) {
                        this.addCommentary(events[Math.floor(Math.random() * events.length)]);
                    }
                }
            }
            
            updateLeaderboardDisplay() {
                const positionsDiv = document.getElementById('positions');
                positionsDiv.innerHTML = this.drivers.map((driver, index) => {
                    const status = driver.finished ? 'FINISHED' : `Lap ${Math.min(this.currentLap, this.totalLaps)}`;
                    
                    let changeIcon = '';
                    let changeClass = 'position-same';
                    if (driver.position < driver.previousPosition) {
                        changeIcon = '‚ñ≤';
                        changeClass = 'position-up';
                    } else if (driver.position > driver.previousPosition) {
                        changeIcon = '‚ñº';
                        changeClass = 'position-down';
                    } else {
                        changeIcon = '=';
                    }
                    
                    return `<div class="position-item">
                        <span class="position-number" style="color: ${driver.team.color}">P${index + 1}</span>
                        <span style="color: ${driver.team.color}; flex-grow: 1;">${driver.team.name}</span>
                        <span class="position-change ${changeClass}">${changeIcon}</span>
                        <span style="font-size: 11px; color: #888;">${status}</span>
                    </div>`;
                }).join('');
            }
            
            updateRaceNarrative(text) {
                document.getElementById('raceNarrative').innerHTML = `
                    <h4>üì¢ Race Director</h4>
                    <p>${text}</p>
                `;
            }
            
            addCommentary(text) {
                const now = Date.now();
                if (now - this.lastCommentaryTime < 600) return;
                
                this.commentary.push({
                    text: text,
                    time: now
                });
                
                if (this.commentary.length > 12) {
                    this.commentary.shift();
                }
                
                this.updateCommentaryDisplay();
                this.lastCommentaryTime = now;
            }
            
            updateCommentaryDisplay() {
                const feed = document.getElementById('commentaryFeed');
                feed.innerHTML = this.commentary.map(comment => 
                    `<div class="commentary-line">${comment.text}</div>`
                ).join('');
                feed.scrollTop = feed.scrollHeight;
            }
            
            forceRaceEnd() {
                this.gameState = 'finished';
                clearInterval(this.raceSimulationInterval);
                clearTimeout(this.raceTimeoutInterval);
                
                // Mark all remaining drivers as finished
                this.drivers.forEach(driver => {
                    if (!driver.finished) {
                        driver.finished = true;
                        driver.finishTime = Date.now() - this.startTime;
                    }
                });
                
                this.showRaceResults();
            }
            
            showRaceResults() {
                const winner = this.drivers.find(driver => driver.position === 1);
                const winnerAnnouncement = document.getElementById('winnerAnnouncement');
                const payoutInfo = document.getElementById('payoutInfo');
                
                winnerAnnouncement.innerHTML = `
                    <h3 style="color: ${winner.team.color}">üèÜ ${winner.team.name} WINS!</h3>
                    <p><strong>Driver:</strong> ${winner.team.driver} (${winner.team.nationality})</p>
                    <p><strong>Race Time:</strong> ${this.formatTime(winner.finishTime)}</p>
                `;
                
                this.addCommentary(`üèÜ RACE COMPLETE! ${winner.team.name} takes the checkered flag in a brilliant victory!`);
                
                let payoutText = '';
                if (this.currentBet && this.currentBet.team.id === winner.id) {
                    const odds = parseFloat(this.currentBet.team.odds.split(':')[0]);
                    const payout = this.currentBet.amount * odds;
                    this.playerMoney += payout;
                    payoutText = `üéâ WINNER! You won $${payout}!`;
                    document.getElementById('money').textContent = this.playerMoney;
                } else if (this.currentBet) {
                    payoutText = `üòî Your bet on ${this.currentBet.team.name} didn't win this time.`;
                } else {
                    payoutText = `You didn't place a bet this race.`;
                }
                
                payoutInfo.innerHTML = `<p style="margin-top: 15px;">${payoutText}</p>`;
                document.getElementById('raceResults').style.display = 'block';
            }
            
            formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = ((ms % 60000) / 1000).toFixed(2);
                return `${minutes}:${seconds.padStart(5, '0')}`;
            }
            
            startRaceUpdates() {
                setInterval(() => {
                    if (this.gameState === 'racing') {
                        const elapsed = Date.now() - this.startTime;
                        document.getElementById('timer').textContent = this.formatTime(elapsed);
                    }
                }, 100);
            }
        }

        // Global functions
        function resetRace() {
            document.getElementById('raceResults').style.display = 'none';
            game.gameState = 'betting';
            game.raceNumber++;
            game.currentBet = null;
            game.selectedTeam = null;
            
            document.getElementById('raceNumber').textContent = game.raceNumber;
            document.getElementById('raceStatus').textContent = 'Betting Open';
            document.getElementById('currentBet').innerHTML = '';
            document.getElementById('timer').textContent = '0:00';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').textContent = '0% Complete';
            document.getElementById('progressText').textContent = 'Race will begin shortly - Place your bets!';
            
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            game.setupDrivers();
            game.updateTeamsList();
            game.updateRaceNarrative(`üèÅ RACE ${game.raceNumber} STARTING! Fresh cars, new strategies, and championship points on the line. The drivers are ready for another 5-minute sprint race!`);
            game.addCommentary(`üé™ Race ${game.raceNumber} is about to begin! Who will claim victory in this championship battle?`);
        }

        function closeStory() {
            document.getElementById('storyDetails').style.display = 'none';
        }

        // Initialize the game
        const game = new RealisticRacingGame();
    </script>
</body>
</html>