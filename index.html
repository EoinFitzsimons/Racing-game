<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Championship Racing Circuit - Text Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            font-family: 'Courier New', monospace;
            overflow-x: hidden;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        #gameContainer {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            padding: 20px;
        }

        #mainContent {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #raceDisplay {
            background: rgba(0,0,0,0.9);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        #trackConditions {
            background: rgba(0,50,100,0.3);
            border: 1px solid #0080ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        #raceNarrative {
            background: rgba(0,0,0,0.5);
            border-left: 4px solid #FFD700;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        #sidePanel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #ui {
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 8px;
        }

        #bettingPanel {
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 8px;
            max-height: 350px;
            overflow-y: auto;
        }

        #leaderboard {
            padding: 15px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            border-radius: 8px;
            min-height: 200px;
        }

        #commentary {
            padding: 15px;
            background: rgba(0,0,0,0.9);
            border: 1px solid #555;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .commentary-line {
            margin: 8px 0;
            padding: 8px;
            border-left: 3px solid #FFD700;
            background: rgba(255,255,255,0.05);
            font-size: 13px;
            animation: fadeIn 0.5s ease-in;
            border-radius: 3px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .team-card {
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .team-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .team-card.selected {
            background: rgba(255,215,0,0.3);
            box-shadow: 0 0 15px rgba(255,215,0,0.5);
        }

        .team-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .team-story {
            font-size: 11px;
            color: #ccc;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .team-odds {
            font-size: 12px;
            color: #4CAF50;
            font-weight: bold;
        }

        #betControls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
        }

        #betAmount {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
            text-align: center;
            font-size: 14px;
        }

        #placeBetBtn, #startRaceBtn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 14px;
        }

        #placeBetBtn:hover, #startRaceBtn:hover {
            background: #45a049;
        }

        #placeBetBtn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        #wallet {
            background: rgba(255,215,0,0.2);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #FFD700;
            font-size: 14px;
            font-weight: bold;
        }

        .position-item {
            margin: 5px 0;
            font-size: 14px;
            padding: 8px;
            border-radius: 5px;
            background: rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .position-number {
            font-weight: bold;
            width: 30px;
            font-size: 16px;
        }

        .position-change {
            font-size: 12px;
            font-weight: bold;
        }

        .position-up { color: #4CAF50; }
        .position-down { color: #f44336; }
        .position-same { color: #FFD700; }

        #raceResults {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 1000;
            border: 2px solid #FFD700;
            max-width: 500px;
        }

        .story-details {
            background: rgba(0,0,0,0.9);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 40px;
            display: none;
            z-index: 1001;
            overflow-y: auto;
        }

        .story-content {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
        }

        .close-story {
            position: absolute;
            top: 20px;
            right: 30px;
            background: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .race-event {
            background: rgba(255,100,100,0.2);
            border: 1px solid #ff6666;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-style: italic;
        }

        .lap-header {
            background: rgba(255,215,0,0.2);
            border: 1px solid #FFD700;
            border-radius: 5px;
            padding: 10px;
            margin: 15px 0 10px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        @media (max-width: 1200px) {
            #gameContainer {
                grid-template-columns: 1fr;
                max-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="mainContent">
            <div id="raceDisplay">
                <div id="trackConditions">
                    <h3>üèÅ CHAMPIONSHIP RACING CIRCUIT üèÅ</h3>
                    <p id="trackInfo">Track: Silverstone International Circuit | Length: 5.891 km</p>
                    <p id="weatherInfo">Weather: Partly Cloudy | Temperature: 22¬∞C | Track: Dry</p>
                    <p id="raceInfo">Race Distance: 3 Laps | Field: 8 Drivers</p>
                </div>
                
                <div id="raceNarrative">
                    <h4>üì¢ Race Control</h4>
                    <p>Welcome to the Championship Racing Circuit! The drivers are taking their positions on the grid. The atmosphere is electric as teams make final preparations for what promises to be an thrilling race.</p>
                    <p><strong>Place your bets and prepare for the green flag!</strong></p>
                </div>
                
                <div id="liveRaceText"></div>
            </div>
        </div>
        
        <div id="sidePanel">
            <div id="ui">
                <div style="display: flex; justify-content: space-between; font-size: 14px;">
                    <div><strong>Race:</strong> <span id="raceNumber">1</span></div>
                    <div><strong>Time:</strong> <span id="timer">0:00</span></div>
                    <div><strong>Status:</strong> <span id="raceStatus">Betting Open</span></div>
                </div>
            </div>

            <div id="bettingPanel">
                <div id="wallet">
                    üí∞ Wallet: $<span id="money">1000</span>
                </div>
                
                <h4 style="text-align: center; margin-bottom: 15px; font-size: 16px;">üèÅ Championship Teams</h4>
                
                <div id="teamsList"></div>
                
                <div id="betControls">
                    <input type="number" id="betAmount" placeholder="Bet Amount" min="10" max="1000" value="50">
                    <button id="placeBetBtn" disabled>Place Bet</button>
                    <button id="startRaceBtn">üèÅ START RACE!</button>
                </div>
                
                <div id="currentBet" style="margin-top: 10px; font-size: 12px; color: #FFD700;"></div>
            </div>

            <div id="leaderboard">
                <div style="font-weight: bold; margin-bottom: 15px; font-size: 16px;">üèÜ Live Positions</div>
                <div id="positions"></div>
            </div>

            <div id="commentary">
                <div style="font-weight: bold; margin-bottom: 15px; font-size: 16px;">üìª Race Commentary</div>
                <div id="commentaryFeed"></div>
            </div>
        </div>

        <div id="raceResults">
            <h2>üèÅ Race Complete!</h2>
            <div id="winnerAnnouncement"></div>
            <div id="payoutInfo"></div>
            <button onclick="resetRace()" style="margin-top: 20px; padding: 15px 25px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Next Race</button>
        </div>

        <div id="storyDetails" class="story-details">
            <button class="close-story" onclick="closeStory()">‚úï</button>
            <div class="story-content" id="storyContent"></div>
        </div>
    </div>

    <script>
        // Enhanced team stories and data
        const teams = [
            {
                id: 0,
                name: "Crimson Shadows",
                color: "#ff4444",
                genre: "Dark Fantasy",
                driver: "Raven",
                car: "Shadow Wraith MK-VII",
                team_description: "Former street racers seeking redemption",
                story: "Born from the ashes of the Great Circuit Wars, Crimson Shadows emerged when underground racer 'Raven' discovered their illegal winnings were being used to fund a children's shelter. Now they race to protect what matters most.",
                racing_style: "Aggressive overtaking with calculated risks",
                signature_move: "The Shadow Pass - diving into corners at impossible angles",
                odds: "4:1",
                skill: 0.75,
                personality: "aggressive"
            },
            {
                id: 1,
                name: "Neon Velocity",
                color: "#44ff44",
                genre: "Cyberpunk",
                driver: "Zap",
                car: "Photon Racer X-9",
                team_description: "Neural-linked racing with illegal tech mods",
                story: "In the neon-soaked streets of Neo-Tokyo, Zap races with illegal neural mods that sync directly with their vehicle. Every turn is calculated by quantum processors, every move predicted by AI.",
                racing_style: "Precision driving with technological assistance",
                signature_move: "The Digital Drift - perfect cornering through computer prediction",
                odds: "3:1",
                skill: 0.80,
                personality: "technical"
            },
            {
                id: 2,
                name: "Azure Lightning",
                color: "#4444ff",
                genre: "Epic Adventure",
                driver: "Storm",
                car: "Sky Rider Tempest",
                team_description: "Noble sky pirates racing for honor",
                story: "Captain Storm once commanded the fastest cloudship in the Seven Skies until politics grounded their fleet. Now they race land-bound vehicles, but their heart still soars with the clouds.",
                racing_style: "Honorable racing with tactical prowess",
                signature_move: "The Storm Surge - building speed through perfect rhythm",
                odds: "5:1",
                skill: 0.70,
                personality: "steady"
            },
            {
                id: 3,
                name: "Golden Eagles",
                color: "#ffff44",
                driver: "Phoenix",
                car: "Rising Sun GT",
                team_description: "Small-town underdogs with big dreams",
                story: "From a small farming town, Phoenix learned to race on dusty back roads with a hand-me-down vehicle. Now they're proving that heart matters more than horsepower.",
                racing_style: "Determined underdog with surprising bursts of speed",
                signature_move: "The Phoenix Rise - gaining strength as the race progresses",
                odds: "6:1",
                skill: 0.65,
                personality: "underdog"
            },
            {
                id: 4,
                name: "Violet Storm",
                color: "#ff44ff",
                driver: "Mystic",
                car: "Ethereal Phantom",
                team_description: "Mystical racers who see beyond the track",
                story: "Legend speaks of a racer who sees the wind before it blows and knows the track before it's built. Mystic races between dimensions, where speed transcends physics.",
                racing_style: "Unpredictable with moments of supernatural precision",
                signature_move: "The Void Walk - disappearing and reappearing ahead",
                odds: "7:1",
                skill: 0.60,
                personality: "mystical"
            },
            {
                id: 5,
                name: "Aqua Titans",
                color: "#44ffff",
                driver: "Tide",
                car: "Ocean's Fury",
                team_description: "Environmental warriors racing for the planet",
                story: "Dr. Tide left their research lab when they realized racing could raise more awareness for ocean conservation than any scientific paper ever could.",
                racing_style: "Smooth and flowing like water currents",
                signature_move: "The Tidal Wave - overwhelming opponents with fluid motion",
                odds: "5:1",
                skill: 0.72,
                personality: "smooth"
            },
            {
                id: 6,
                name: "Solar Flare",
                color: "#ffa544",
                driver: "Nova",
                car: "Stellar Interceptor",
                team_description: "Interplanetary couriers racing against time",
                story: "When the outer colonies stopped communicating, Nova volunteered for the most dangerous job in the galaxy - racing through asteroid fields to maintain contact.",
                racing_style: "High-risk, high-reward space pilot techniques",
                signature_move: "The Solar Burst - explosive acceleration through danger",
                odds: "4:1",
                skill: 0.78,
                personality: "risky"
            },
            {
                id: 7,
                name: "Cosmic Void",
                color: "#a544ff",
                driver: "Void",
                car: "Reality Shifter",
                team_description: "Guardians racing to protect dimensional barriers",
                story: "Void races not for glory or prize money, but because someone must guard the thin places where reality grows weak. Each race is a battle against cosmic horror.",
                racing_style: "Erratic but purposeful, defying conventional racing logic",
                signature_move: "The Void Shift - reality-bending position changes",
                odds: "8:1",
                skill: 0.55,
                personality: "erratic"
            }
        ];

        const raceEvents = [
            "takes the racing line perfectly through the chicane",
            "makes a daring overtake on the outside",
            "hits their braking point perfectly",
            "carries more speed through the corner",
            "finds extra grip on the racing line",
            "makes a strategic defensive move",
            "gains a slipstream advantage",
            "nails the apex with surgical precision",
            "uses DRS to gain crucial speed",
            "makes a late-braking maneuver",
            "finds pace in the technical section",
            "maintains momentum through the esses",
            "executes a perfectly timed overtake",
            "defends their position expertly",
            "loses grip on the exit",
            "runs slightly wide",
            "has a moment of oversteer",
            "fights back after a poor start",
            "struggles with tire degradation",
            "makes a small mistake but recovers quickly"
        ];

        class TextRacingGame {
            constructor() {
                this.gameState = 'betting'; // betting, racing, finished
                this.startTime = 0;
                this.raceNumber = 1;
                this.raceDistance = 3; // 3 laps
                this.currentLap = 1;
                
                this.drivers = [];
                this.commentary = [];
                this.lastCommentaryTime = 0;
                this.raceEventTimer = 0;
                
                this.playerMoney = 1000;
                this.currentBet = null;
                this.selectedTeam = null;
                
                this.setupUI();
                this.setupDrivers();
                this.updateTeamsList();
                this.addCommentary("üèÅ Welcome to the Championship Racing Circuit! Drivers are preparing for the race.");
                this.startRaceUpdates();
            }
            
            setupDrivers() {
                this.drivers = teams.map((team, i) => ({
                    id: team.id,
                    team: team,
                    position: i + 1,
                    previousPosition: i + 1,
                    lap: 0,
                    lapTimes: [],
                    totalTime: 0,
                    finished: false,
                    finishTime: 0,
                    raceSkill: Math.max(0.3, Math.min(0.95, team.skill + (Math.random() - 0.5) * 0.3)),
                    currentSpeed: 0,
                    incidents: [],
                    personality: team.personality,
                    racePace: 1.0,
                    momentum: 1.0
                }));
            }
            
            setupUI() {
                document.getElementById('startRaceBtn').addEventListener('click', () => {
                    if (this.gameState === 'betting') {
                        this.startRace();
                    }
                });
                
                document.getElementById('placeBetBtn').addEventListener('click', () => {
                    this.placeBet();
                });
                
                document.getElementById('betAmount').addEventListener('input', (e) => {
                    this.updateBetButton();
                });
            }
            
            updateTeamsList() {
                const teamsList = document.getElementById('teamsList');
                teamsList.innerHTML = '';
                
                teams.forEach(team => {
                    const teamCard = document.createElement('div');
                    teamCard.className = 'team-card';
                    teamCard.style.borderLeftColor = team.color;
                    teamCard.onclick = () => this.selectTeam(team);
                    teamCard.ondblclick = () => this.showStory(team);
                    
                    teamCard.innerHTML = `
                        <div class="team-name" style="color: ${team.color}">${team.name}</div>
                        <div class="team-story">${team.team_description}</div>
                        <div style="font-size: 10px; color: #999; margin: 3px 0;">Driver: ${team.driver} | Car: ${team.car}</div>
                        <div class="team-odds">Odds: ${team.odds} | Skill: ${Math.round(team.skill * 100)}%</div>
                    `;
                    
                    teamsList.appendChild(teamCard);
                });
                
                this.updateBetButton();
            }
            
            selectTeam(team) {
                this.selectedTeam = team;
                
                document.querySelectorAll('.team-card').forEach(card => {
                    card.classList.remove('selected');
                });
                event.target.closest('.team-card').classList.add('selected');
                
                this.updateBetButton();
            }
            
            updateBetButton() {
                const betBtn = document.getElementById('placeBetBtn');
                const betAmount = parseInt(document.getElementById('betAmount').value) || 0;
                
                if (this.selectedTeam && betAmount >= 10 && betAmount <= this.playerMoney && !this.currentBet) {
                    betBtn.disabled = false;
                    betBtn.textContent = `Bet $${betAmount} on ${this.selectedTeam.name}`;
                } else if (this.currentBet) {
                    betBtn.disabled = true;
                    betBtn.textContent = 'Bet Placed ‚úì';
                } else {
                    betBtn.disabled = true;
                    betBtn.textContent = 'Select Team & Amount';
                }
            }
            
            placeBet() {
                if (!this.selectedTeam) return;
                
                const betAmount = parseInt(document.getElementById('betAmount').value) || 0;
                if (betAmount < 10 || betAmount > this.playerMoney) return;
                
                this.currentBet = {
                    team: this.selectedTeam,
                    amount: betAmount
                };
                
                this.playerMoney -= betAmount;
                document.getElementById('money').textContent = this.playerMoney;
                document.getElementById('currentBet').innerHTML = `
                    üéØ Bet: $${betAmount} on <span style="color: ${this.selectedTeam.color}">${this.selectedTeam.name}</span>
                `;
                
                this.addCommentary(`üí∞ ${this.selectedTeam.name} receives crowd support with a $${betAmount} bet!`);
                this.updateBetButton();
            }
            
            showStory(team) {
                const storyContent = document.getElementById('storyContent');
                storyContent.innerHTML = `
                    <h2 style="color: ${team.color}; text-align: center; margin-bottom: 20px;">${team.name}</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div><strong>Driver:</strong> ${team.driver}</div>
                        <div><strong>Car:</strong> ${team.car}</div>
                        <div><strong>Genre:</strong> ${team.genre}</div>
                        <div><strong>Racing Style:</strong> ${team.racing_style}</div>
                    </div>
                    
                    <h3>Team Background</h3>
                    <p style="margin-bottom: 15px;">${team.team_description}</p>
                    
                    <h3>Driver Story</h3>
                    <p style="margin-bottom: 15px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid ${team.color};">
                        ${team.story}
                    </p>
                    
                    <h3>Signature Move</h3>
                    <p style="font-style: italic; color: ${team.color};">${team.signature_move}</p>
                `;
                
                document.getElementById('storyDetails').style.display = 'block';
            }
            
            startRace() {
                this.gameState = 'racing';
                this.startTime = Date.now();
                this.currentLap = 1;
                document.getElementById('raceStatus').textContent = 'Racing!';
                
                this.setupDrivers();
                this.updateRaceNarrative("üö• GREEN FLAG! The race is underway! All drivers launch from the starting grid as the championship battle begins!");
                this.addCommentary("üèÅ AND THEY'RE OFF! The drivers surge forward as the green flag waves!");
                
                // Start the race simulation
                this.raceSimulationInterval = setInterval(() => this.simulateRaceProgress(), 2000);
            }
            
            simulateRaceProgress() {
                if (this.gameState !== 'racing') return;
                
                // Simulate each driver's progress
                this.drivers.forEach(driver => {
                    if (driver.finished) return;
                    
                    // Apply personality and skill effects
                    let paceModifier = this.calculatePaceModifier(driver);
                    
                    // Random race events
                    if (Math.random() < 0.15) {
                        this.generateRaceEvent(driver);
                    }
                    
                    // Update driver progress
                    driver.racePace = Math.max(0.5, Math.min(1.5, driver.racePace + (Math.random() - 0.5) * 0.2));
                    
                    // Check for lap completion
                    if (Math.random() < 0.3 * driver.raceSkill * paceModifier) {
                        this.completeLap(driver);
                    }
                });
                
                this.updatePositions();
                this.generateRaceCommentary();
                this.checkRaceComplete();
            }
            
            calculatePaceModifier(driver) {
                let modifier = 1.0;
                
                switch (driver.personality) {
                    case "aggressive":
                        modifier = 1.0 + Math.random() * 0.15;
                        break;
                    case "technical":
                        modifier = 1.05;
                        break;
                    case "steady":
                        modifier = 1.0;
                        break;
                    case "underdog":
                        modifier = 0.9 + (driver.lap * 0.05); // Gets stronger
                        break;
                    case "mystical":
                        modifier = 0.95 + Math.sin(Date.now() * 0.001) * 0.15;
                        break;
                    case "smooth":
                        modifier = 1.08;
                        break;
                    case "risky":
                        modifier = 1.1 + Math.random() * 0.2 - 0.1;
                        break;
                    case "erratic":
                        modifier = 0.8 + Math.random() * 0.4;
                        break;
                }
                
                return modifier;
            }
            
            generateRaceEvent(driver) {
                const event = raceEvents[Math.floor(Math.random() * raceEvents.length)];
                const impact = Math.random() > 0.5 ? 0.1 : -0.1;
                
                driver.momentum += impact;
                driver.momentum = Math.max(0.5, Math.min(1.5, driver.momentum));
                
                if (Math.random() < 0.3) {
                    this.addCommentary(`üèéÔ∏è ${driver.team.name} ${event}!`);
                }
            }
            
            completeLap(driver) {
                driver.lap++;
                const lapTime = 95 + Math.random() * 10 + (1 - driver.raceSkill) * 15;
                driver.lapTimes.push(lapTime);
                driver.totalTime += lapTime;
                
                if (driver.lap === 1) {
                    this.addCommentary(`üèÅ ${driver.team.name} completes their first lap in ${lapTime.toFixed(2)}s!`);
                } else {
                    this.addCommentary(`üìä ${driver.team.name} - Lap ${driver.lap}: ${lapTime.toFixed(2)}s`);
                }
                
                if (driver.lap >= this.raceDistance && !driver.finished) {
                    driver.finished = true;
                    driver.finishTime = Date.now() - this.startTime;
                    this.addCommentary(`üèÜ ${driver.team.name} crosses the finish line!`);
                    
                    if (this.drivers.filter(d => d.finished).length === 1) {
                        this.updateRaceNarrative(`ü•á CHECKERED FLAG! ${driver.team.name} takes the victory in a commanding performance! What a race!`);
                    }
                }
                
                // Update lap display
                if (driver.lap > this.currentLap && driver.lap <= this.raceDistance) {
                    this.currentLap = driver.lap;
                    this.updateRaceNarrative(`üîÑ LAP ${this.currentLap} - The field spreads out as drivers settle into their racing rhythm. Position battles are heating up throughout the pack!`);
                }
            }
            
            updatePositions() {
                // Sort drivers by race progress
                this.drivers.sort((a, b) => {
                    if (a.finished && !b.finished) return -1;
                    if (!a.finished && b.finished) return 1;
                    if (a.finished && b.finished) return a.finishTime - b.finishTime;
                    
                    if (a.lap !== b.lap) return b.lap - a.lap;
                    return a.totalTime - b.totalTime;
                });
                
                // Update positions and track changes
                this.drivers.forEach((driver, index) => {
                    driver.previousPosition = driver.position;
                    driver.position = index + 1;
                });
                
                // Generate position change commentary
                this.drivers.forEach(driver => {
                    if (driver.previousPosition !== driver.position && this.gameState === 'racing') {
                        if (driver.position < driver.previousPosition) {
                            this.addCommentary(`üìà ${driver.team.name} moves up to P${driver.position}!`);
                        } else if (driver.position > driver.previousPosition) {
                            this.addCommentary(`üìâ ${driver.team.name} drops to P${driver.position}`);
                        }
                    }
                });
                
                this.updateLeaderboardDisplay();
            }
            
            generateRaceCommentary() {
                if (Math.random() < 0.4) {
                    const randomDriver = this.drivers[Math.floor(Math.random() * this.drivers.length)];
                    const events = [
                        `üéØ ${randomDriver.team.name} is showing great pace in the middle sector`,
                        `‚ö° ${randomDriver.team.name} sets the fastest mini-sector time`,
                        `üî• ${randomDriver.team.name} is really pushing their car to the limit`,
                        `üí® ${randomDriver.team.name} finds extra speed on the main straight`,
                        `üé¢ ${randomDriver.team.name} navigates the technical section beautifully`,
                        `‚öñÔ∏è ${randomDriver.team.name} manages their tires expertly`,
                        `üé™ ${randomDriver.team.name} puts on a masterclass in racecraft`
                    ];
                    
                    if (!randomDriver.finished) {
                        this.addCommentary(events[Math.floor(Math.random() * events.length)]);
                    }
                }
            }
            
            updateLeaderboardDisplay() {
                const positionsDiv = document.getElementById('positions');
                positionsDiv.innerHTML = this.drivers.map((driver, index) => {
                    const status = driver.finished ? 'FINISHED' : `Lap ${driver.lap}/${this.raceDistance}`;
                    
                    let changeIcon = '';
                    let changeClass = 'position-same';
                    if (driver.position < driver.previousPosition) {
                        changeIcon = '‚ñ≤';
                        changeClass = 'position-up';
                    } else if (driver.position > driver.previousPosition) {
                        changeIcon = '‚ñº';
                        changeClass = 'position-down';
                    } else {
                        changeIcon = '=';
                    }
                    
                    return `<div class="position-item">
                        <span class="position-number" style="color: ${driver.team.color}">P${index + 1}</span>
                        <span style="color: ${driver.team.color}; flex-grow: 1;">${driver.team.name}</span>
                        <span class="position-change ${changeClass}">${changeIcon}</span>
                        <span style="font-size: 11px; color: #888;">${status}</span>
                    </div>`;
                }).join('');
            }
            
            updateRaceNarrative(text) {
                document.getElementById('raceNarrative').innerHTML = `
                    <h4>üì¢ Race Control</h4>
                    <p>${text}</p>
                `;
            }
            
            addCommentary(text) {
                const now = Date.now();
                if (now - this.lastCommentaryTime < 800) return;
                
                this.commentary.push({
                    text: text,
                    time: now
                });
                
                if (this.commentary.length > 15) {
                    this.commentary.shift();
                }
                
                this.updateCommentaryDisplay();
                this.lastCommentaryTime = now;
            }
            
            updateCommentaryDisplay() {
                const feed = document.getElementById('commentaryFeed');
                feed.innerHTML = this.commentary.map(comment => 
                    `<div class="commentary-line">${comment.text}</div>`
                ).join('');
                feed.scrollTop = feed.scrollHeight;
            }
            
            checkRaceComplete() {
                const finishedDrivers = this.drivers.filter(driver => driver.finished);
                if (finishedDrivers.length === this.drivers.length || 
                   (finishedDrivers.length > 0 && Date.now() - this.startTime > 120000)) {
                    this.gameState = 'finished';
                    clearInterval(this.raceSimulationInterval);
                    this.showRaceResults();
                }
            }
            
            showRaceResults() {
                const winner = this.drivers.find(driver => driver.position === 1);
                const winnerAnnouncement = document.getElementById('winnerAnnouncement');
                const payoutInfo = document.getElementById('payoutInfo');
                
                winnerAnnouncement.innerHTML = `
                    <h3 style="color: ${winner.team.color}">üèÜ ${winner.team.name} WINS!</h3>
                    <p><strong>Driver:</strong> ${winner.team.driver}</p>
                    <p><strong>Race Time:</strong> ${this.formatTime(winner.finishTime || Date.now() - this.startTime)}</p>
                `;
                
                this.addCommentary(`üèÜ RACE COMPLETE! ${winner.team.name} takes the checkered flag in a spectacular victory!`);
                
                let payoutText = '';
                if (this.currentBet && this.currentBet.team.id === winner.id) {
                    const odds = parseFloat(this.currentBet.team.odds.split(':')[0]);
                    const payout = this.currentBet.amount * odds;
                    this.playerMoney += payout;
                    payoutText = `üéâ WINNER! You won $${payout}!`;
                    document.getElementById('money').textContent = this.playerMoney;
                } else if (this.currentBet) {
                    payoutText = `üòî Your bet on ${this.currentBet.team.name} didn't win this time.`;
                } else {
                    payoutText = `You didn't place a bet this race.`;
                }
                
                payoutInfo.innerHTML = `<p style="margin-top: 15px;">${payoutText}</p>`;
                document.getElementById('raceResults').style.display = 'block';
            }
            
            formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = ((ms % 60000) / 1000).toFixed(2);
                return `${minutes}:${seconds.padStart(5, '0')}`;
            }
            
            startRaceUpdates() {
                setInterval(() => {
                    if (this.gameState === 'racing') {
                        const elapsed = Date.now() - this.startTime;
                        document.getElementById('timer').textContent = this.formatTime(elapsed);
                    }
                }, 100);
            }
        }

        // Global functions
        function resetRace() {
            document.getElementById('raceResults').style.display = 'none';
            game.gameState = 'betting';
            game.raceNumber++;
            game.currentBet = null;
            game.selectedTeam = null;
            
            document.getElementById('raceNumber').textContent = game.raceNumber;
            document.getElementById('raceStatus').textContent = 'Betting Open';
            document.getElementById('currentBet').innerHTML = '';
            document.getElementById('timer').textContent = '0:00';
            
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            game.setupDrivers();
            game.updateTeamsList();
            game.updateRaceNarrative("üèÅ NEW RACE STARTING! Drivers are taking their positions on the grid. Place your bets for the next thrilling race!");
            game.addCommentary(`üé™ Race ${game.raceNumber} is about to begin! Who will claim victory this time?`);
        }

        function closeStory() {
            document.getElementById('storyDetails').style.display = 'none';
        }

        // Initialize the game
        const game = new TextRacingGame();
    </script>
</body>
</html>